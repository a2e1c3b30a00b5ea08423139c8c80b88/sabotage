#!/bin/sh
if [ -z "$S" ] ; then
	echo 'S not set, did you source config ?'
	exit 1
fi
pkg=$1
if [ -z "$pkg" ] ; then
	echo 'this script unlinks all files installed by a package.'
	echo 'need package name as argv!'
	exit 1
fi

[ -z "$butch_filelists" ] && butch_filelists="$S"/filelists
fl="$butch_filelists"/"$pkg".txt
tmp=
if [ ! -e "$fl" ] ; then
	echo "warning: filelist $fl does not exist, trying to create one on the fly.">&2
	[ -z "$butch_staging_dir" ] && butch_staging_dir=/opt
	pd="$R$butch_staging_dir/$pkg"
	tmp=$(mktemp -u).$$
	trap "rm -f $tmp" INT HUP TERM
	fl="$tmp"
	"$K"/bin/butch-genfilelist -D "$pd" - > "$fl" || {
		rm -f "$fl"
		echo "error: failed to regenerate temp filelist $fl from $pd.">&2
		exit 1
	}
fi

while read f ; do
	# remove leading "."
	fs="${f##.}"
	[ "$R" = "/" ] || fs="$R""$fs"
	if [ -L "$fs" ] ; then
		rm -f "$fs" && echo "$fs removed successfully"
	fi
done < "$fl"
test -n "$tmp" && rm -f "$tmp"
exit 0
