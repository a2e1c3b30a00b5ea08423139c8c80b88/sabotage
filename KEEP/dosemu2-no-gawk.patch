--- dosemu2-2.0pre9.orig/src/base/bios/x86/Makefile	2024-01-16 01:44:18.406463496 +0000
+++ dosemu2-2.0pre9/src/base/bios/x86/Makefile	2024-01-16 02:23:11.181750099 +0000
@@ -33,7 +33,33 @@
 	echo "\";" >>$@
 
 bios_symbols.c: bios1.elf
-	nm -g -n $< | gawk '\
+	nm -g -n $< | awk '\
+		function mystrtonum(str,        ret, n, i, k, c)\
+		{\
+		    if (str ~ /^0[0-7]*$$/) {\
+		        n = length(str);\
+		        ret = 0;\
+		        for (i = 1; i <= n; i++) {\
+		            c = substr(str, i, 1);\
+		            k = index("1234567", c);\
+		            ret = ret * 8 + k;\
+		        }\
+		    } else if (str ~ /^0[xX][[:xdigit:]]+$$/) {\
+		        str = substr(str, 3);    # lop off leading 0x\
+		        n = length(str);\
+		        ret = 0;\
+		        for (i = 1; i <= n; i++) {\
+		            c = substr(str, i, 1);\
+		            c = tolower(c);\
+		            k = index("123456789abcdef", c);\
+		            ret = ret * 16 + k;\
+		        }\
+		    } else if (str ~ /^[-+]?([0-9]+([.][0-9]*([Ee][0-9]+)?)?|([.][0-9]+([Ee][-+]?[0-9]+)?))$$/) {\
+		        ret = str + 0;\
+		    } else\
+		        ret = "NOT-A-NUMBER";\
+		    return ret;\
+		}\
 		BEGIN {\
 		  COUNT=0;\
 		  print "// Warning: autogenerated";\
@@ -44,7 +70,7 @@
 		}\
 		{\
 		  HEXSTR = sprintf("0x%s", $$1);\
-		  ADDR = strtonum(HEXSTR);\
+		  ADDR = mystrtonum(HEXSTR);\
 		  if (ADDR <= 0xffff) {\
 		    COUNT++;\
 		    printf "  { 0x%04x, \"%s\" },\n", ADDR, $$3;\
@@ -58,14 +84,40 @@
 		' > $@ || (rm -f $@ ; false)
 
 bios_offsets.hh: bios2.elf
-	nm -g -n $< | gawk '\
+	nm -g -n $< | awk '\
+		function mystrtonum(str,        ret, n, i, k, c)\
+		{\
+		    if (str ~ /^0[0-7]*$$/) {\
+		        n = length(str);\
+		        ret = 0;\
+		        for (i = 1; i <= n; i++) {\
+		            c = substr(str, i, 1);\
+		            k = index("1234567", c);\
+		            ret = ret * 8 + k;\
+		        }\
+		    } else if (str ~ /^0[xX][[:xdigit:]]+$$/) {\
+		        str = substr(str, 3);    # lop off leading 0x\
+		        n = length(str);\
+		        ret = 0;\
+		        for (i = 1; i <= n; i++) {\
+		            c = substr(str, i, 1);\
+		            c = tolower(c);\
+		            k = index("123456789abcdef", c);\
+		            ret = ret * 16 + k;\
+		        }\
+		    } else if (str ~ /^[-+]?([0-9]+([.][0-9]*([Ee][0-9]+)?)?|([.][0-9]+([Ee][-+]?[0-9]+)?))$$/) {\
+		        ret = str + 0;\
+		    } else\
+		        ret = "NOT-A-NUMBER";\
+		    return ret;\
+		}\
 		BEGIN {\
 		  print "// Warning: autogenerated";\
 	          print "";\
 		}\
 		{\
 		  HEXSTR = sprintf("0x%s", $$1);\
-		  ADDR = strtonum(HEXSTR);\
+		  ADDR = mystrtonum(HEXSTR);\
 		  if (ADDR <= 0xffff) {\
 		    printf "#define %s 0x%04x\n", $$3, ADDR;\
 		  }\
