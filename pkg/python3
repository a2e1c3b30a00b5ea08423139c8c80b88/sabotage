[mirrors]
https://www.python.org/ftp/python/3.10.18/Python-3.10.18.tar.xz

[vars]
filesize=19619316
sha512=2c444f024cd15babd156964b50aa0245020a17c0c600250ffcf112e91594a3d6e1fb87c9b87a57cb7a802dae90004d801ed95a3103d79aefb8ed714279997708
pkgver=7
desc='interpreter for the python 3.x scripting language'
python3_minor=10

[deps]
libc
curses
libressl
bzip2
expat
libffi
readline
gettext
zlib

[build]
# work around buggy installer which puts stuff into prefix directly
# (omitting destdir) when the prefix equals "/"
[ "$butch_prefix" = "/" ] && butch_prefix=

# python can't deal with prefix= or prefix=/ correctly.
# it searches for stuff only relative to its own binary.
# this doesn't work well with our symlink relocation strategy.
# we hardcode a check for $butch_staging_dir and skip to / if it's seen.
patch -p1 < "$K"/python3.9-pathsearch.patch
patch -p1 < "$K"/python3.8-xcompile.patch
patch -p1 < "$K"/python3.8-includedirs.patch
#patch -p1 < "$K"/python3-UTF-8.patch # TODO
patch -p1 < "$K"/python3.10-sysconfig-prefix.patch

# if PYTHON_SMALL_AND_SLOW is set, we disable automatic creation of .pyc and
# .pyo bytecode files. the result is small delay on startup (up to 2.5x slower)
# but substantial savings in disk space (31 vs 22 MB on x86_64)).
if test "$PYTHON_SMALL_AND_SLOW" = 1 ; then
  patch -p1 < "$K"/python3-dont_write_bytecode.patch
else
  # the patch to disable python .pyo optimization would go here,
  # but it isn't necessary for now.
  :
fi

# TODO:
# below lines are commented out, because even though they should improve libedit support,
# the resulting readline module doesn't deal correctly with tab completion.
# for example "completing text" code from https://pymotw.com/2/readline/
# in order to use it, one has to uncomment and add -DLIBEDIT_SUPPORT to EXTRA_CFLAGS
#
# official libedit support is mistakenly only added for __APPLE__
#sed -i 's/__APPLE__/LIBEDIT_SUPPORT/g' Modules/readline.c
# patch out unnecessary strdup/setlocale calls, which workaround a GNU readline bug
#sed -i 's/HAVE_SETLOCALE/HAVE_SETLOCALE) \&\& !defined(LIBEDIT_SUPPORT/g' Modules/readline.c

sed -i 's@return readline@return feedline@' configure

[ -n "$CROSS_COMPILE" ] && \
  xconfflags="--host=$($CC -dumpmachine) --build=$($HOSTCC -dumpmachine)"

# borrowed from archlinux:
sed -i -e "s|^#.* /usr/local/bin/python|#!/bin/python3|" Lib/cgi.py
find . -name '*.py' -exec \
  sed -i "s|#[ ]*![ ]*/usr/bin/env python$|#!/usr/bin/env python3|" {} +

CFLAGS="-D_GNU_SOURCE -D_BSD_SOURCE -fPIC -DBUTCH_STAGING_DIR='\"$butch_staging_dir/\"'" \
OPT="$optcflags" \
LDFLAGS="$optldflags -lncursesw -lterminfo" \
./configure -C --prefix="$butch_prefix" \
  --with-system-expat --with-system-ffi $xconfflags \
  --without-cxx-main \
  ac_cv_lib_readline_rl_callback_handler_install=no \
  ac_cv_lib_readline_rl_pre_input_hook=no \
  ac_cv_lib_readline_rl_completion_display_matches_hook=no \
  ac_cv_lib_readline_rl_completion_matches=yes \
  ac_cv_have_long_long_format=yes \
  ac_cv_func_timegm=yes \
  ac_cv_file__dev_ptc=no \
  ac_cv_file__dev_ptmx=yes

if [ -n "$CROSS_COMPILE" ] ; then
  # temporarily use the host's sizes of types for the parser generator.
  cp pyconfig.h pyconfig.h.target
  for i in SIZEOF_LONG SIZEOF_PTHREAD_T SIZEOF_SIZE_T SIZEOF_TIME_T SIZEOF_VOID_P SIZEOF_UINTPTR_T ; do
    sed -i 's,#define '$i',//,' pyconfig.h
  done
  printf "%s\n" 'int main() { printf("%zu\n", sizeof(time_t)); return 0;}' > foo.c
  $HOSTCC -include time.h -include stdio.h foo.c
  l=$(./a.out)
cat << EOF >> pyconfig.h
#define SIZEOF_LONG __SIZEOF_LONG__
#define SIZEOF_PTHREAD_T SIZEOF_LONG
#define SIZEOF_SIZE_T SIZEOF_LONG
#define SIZEOF_VOID_P SIZEOF_LONG
#define SIZEOF_UINTPTR_T SIZEOF_LONG
#define SIZEOF_TIME_T $l
EOF
  make Tools/peg_generator/pegen CC="$HOSTCC" -j$MAKE_THREADS
  cp pyconfig.h.target pyconfig.h
else
  make Tools/peg_generator/pegen -j$MAKE_THREADS
fi

make -j$MAKE_THREADS

make DESTDIR="$butch_install_dir" altinstall

dest="$butch_install_dir""$butch_prefix"

# removing tests
for test in sqlite3/test email/test ctypes/test test unittest/test tkinter/test \
            bsddb/test json/tests lib2to3/tests distutils/tests tests ; do
  rm -rf "$dest"/lib/python3.${python3_minor}/"$test"
done

# remove hardcoded CFLAGS interfering with cross builds
# note: OPT is only used if CFLAGS are exported in environment.
sed -i "s,'OPT': '.*','OPT': ''," "$dest"/lib/python3.${python3_minor}/_sysconfigdata_*.py

if test "$PYTHON_SMALL_AND_SLOW" = 1 ; then
  # removing precompiled python code, if any
  find "$dest"/lib/python3.${python3_minor}/ -name '*.pyo' -or -name '*.pyc' -delete
else
  # precompile all .pyc files now rather than on first use, so they're part of
  # the package directory
  test -n "$CROSS_COMPILE" || ./python -E Lib/compileall.py "$dest"/lib/python3.${python3_minor}
fi

# create symlinks without the minor version number in them
cd "$dest/bin"
for bin in idle3.${python3_minor} 2to3-3.${python3_minor} pip3.${python3_minor} easy_install-3.${python3_minor} \
           python3.${python3_minor} pyvenv-3.${python3_minor} python3.${python3_minor}m pydoc3.${python3_minor} python3.${python3_minor}m-config ; do
  if [ -e "$bin" ]; then
      newbin=$(printf "%s\n" "$bin" | sed 's/3\.'"${python3_minor}"'/3/')
      ln -sf "$bin" "${newbin}"
  fi
done
